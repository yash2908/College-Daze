function puzzleCookieIsSame(){var e=$.parseJSON($.cookie(currentPuzzleType.toLowerCase()+"_cells"));for(var t in e){var o=e[t],l=myCells[t];if(o.x!=l.x||o.y!=l.y||o.clue!=l.clue)return!1}var r=$.parseJSON($.cookie(currentPuzzleType.toLowerCase()+"_edges"));if(r.length!=myEdges.length)return!1;for(var t in r){var s=r[t],n=myEdges[t];if(s.answer!=n.answer)return!1}return!0}function initNewPuzzle(){setStatus(""),""!=initStatus&&puzzleMessage([initStatus]),startTime=(new Date).getTime();for(var e=0;e<myEdges.length;++e)myEdges[e].f=0;$.cookie(currentPuzzleType.toLowerCase()+"_edges")&&$.cookie(currentPuzzleType.toLowerCase()+"_cells")&&$.cookie(currentPuzzleType.toLowerCase()+"_solution_id",{useLocalStorage:!1})==puzzleID&&puzzleCookieIsSame()?(myCells=$.parseJSON($.cookie(currentPuzzleType.toLowerCase()+"_cells")),myEdges=$.parseJSON($.cookie(currentPuzzleType.toLowerCase()+"_edges")),startTime=$.cookie(currentPuzzleType.toLowerCase()+"_startTime")):($.cookie(currentPuzzleType.toLowerCase()+"_startTime")||setTimeout(provideInstructions,4e3),$.cookie(currentPuzzleType.toLowerCase()+"_startTime",startTime,{expires:14})),gPuzzleIsComplete=checkIfSolved(),refreshCanvas(),$("#spinnercontainer").hide(),setTimeout(function(){$("#logocontainer").fadeOut("slow")},1e3)}function addrInPuzzle(e){return!0}function fillCircle(e,t,o){gDC.beginPath(),gDC.arc(e,t,o,0,6.28318,!1),gDC.fill()}function fillAndStrokeCircle(e,t,o){gDC.beginPath(),gDC.arc(e,t,o,0,6.28318,!1),gDC.fill(),gDC.stroke()}function drawLine(e,t,o,l){gDC.beginPath(),gDC.moveTo(e,t),gDC.lineTo(o,l),gDC.stroke()}function drawX(e,t){var o=gCellWidth/10;drawLine(e-o,t-o,e+o,t+o),drawLine(e-o,t+o,e+o,t-o)}function dottedCircle(e,t,o,l){gDC.save();for(var r=2*Math.PI/l,s=r/4,n=-s/2,a=0;a<l;++a)gDC.beginPath(),gDC.arc(e,t,o,n+r*a,n+r*a+s),gDC.stroke();gDC.restore()}function strokeCircle(e,t,o){gDC.beginPath(),gDC.arc(e,t,o,0,6.28318,!1),gDC.stroke()}var lastState,lastSource,lastX=-1,lastY=-1,autoXPts={};function autoXPoint(e,t,o){var l=e+" "+t;if(!(l in autoXPts))for(var r=o+(autoXPts[l]=1);r<myEdges.length;++r){var s=myEdges[r];if(!(2!=s.s||2==s.s!=s.answer&&puzzlePrefs.autoCheckAnswers)&&(s.x1==e&&s.y1==t||s.x2==e&&s.y2==t)&&(s.x1==e&&s.y1==t||s.x2==e&&s.y2==t))for(var n=0;n<myEdges.length;++n){var a=myEdges[n];0==a.s&&(a.x1==e&&a.y1==t||a.x2==e&&a.y2==t)&&(a.s=1)}}}var autoX=function(e){autoXPts={};for(e=0;e<myEdges.length;++e){var t=myEdges[e];2!=t.s||2==t.s!=t.answer&&puzzlePrefs.autoCheckAnswers||(autoXPoint(t.x1,t.y1,e),autoXPoint(t.x2,t.y2,e))}},wontMakeT=function(e){for(var t=myEdges[e],o=t.x1,l=t.y1,r=0,s=0;s<myEdges.length;++s)if(2==myEdges[s].s&&(myEdges[s].x1==o&&myEdges[s].y1==l||myEdges[s].x2==o&&myEdges[s].y2==l)&&2==(r+=1))return!1;o=t.x2,l=t.y2;for(s=r=0;s<myEdges.length;++s)if(2==myEdges[s].s&&(myEdges[s].x1==o&&myEdges[s].y1==l||myEdges[s].x2==o&&myEdges[s].y2==l)&&2==(r+=1))return!1;return!0};function checkIfSolved(){for(var e=!0,t=0;t<myEdges.length;++t){var o=myEdges[t];if(2==o.s!=o.answer){e=!1;break}}return e}function checkForErrors(){for(var e=0,t=0;t<myEdges.length;++t){var o=myEdges[t];0!=o.s&&2==o.s!=o.answer&&(e+=o.f=1)}return e}function loadMyAnswer(){for(var e=0;e<myEdges.length;++e)myEdges[e].s=myEdges[e].answer?2:1,myEdges[e].f=0}function createSweepCommand(e){return{tool:e,pc:CloneCells(myCells),pe:CloneEdges(myEdges)}}function saveSolutionCookies(){$.cookie(currentPuzzleType.toLowerCase()+"_cells",JSON.stringify(myCells),{expires:14}),$.cookie(currentPuzzleType.toLowerCase()+"_edges",JSON.stringify(myEdges),{expires:14}),$.cookie(currentPuzzleType.toLowerCase()+"_solution_id",puzzleID,{useLocalStorage:!1,expires:14})}function clearMyPuzzle(){for(var e=0;e<myEdges.length;++e)myEdges[e].s=0,myEdges[e].f=0;for(e=0;e<myCells.length;++e)myCells[e].fill=0;gPuzzleIsComplete=!1,saveSolutionCookies()}function ApplyMove(e){if("loadanswer"==e.tool)loadMyAnswer();else if("clearpuzzle"==e.tool)clearMyPuzzle(),initNewPuzzle();else if("setedge"==e.tool){var t=e.addr,o=e.es;if(-1!=t){var l=myEdges[t];l.s=o,l.f=0,2==l.s&&puzzlePrefs.autoX&&autoX(),checkIfSolved()?(gPuzzleIsComplete=!0,DebutSuccessAnimation(),SuccessLog()):gPuzzleIsComplete=!1}}else{t=e.addr;myCells[t].fill=e.fill}}function UnapplyMove(e){if("loadanswer"==e.tool||"clearpuzzle"==e.tool)myCells=CloneCells(e.pc),myEdges=CloneEdges(e.pe);else if("setedge"==e.tool)myEdges=CloneEdges(e.pe);else{var t=e.addr;myCells[t].fill=e.prevFill}gPuzzleIsComplete=!1}var lastFill,CloneEdges=function(e){var t=[];for(var o in e){var l=e[o],r={x1:l.x1,x2:l.x2,y1:l.y1,y2:l.y2,s:l.s,f:l.f,answer:l.answer};t.push(r)}return t};function CloneCells(e){var t=[];for(var o in e){var l=e[o],r={clue:l.clue,idx:l.idx,x:l.x,y:l.y,fill:l.fill,edges:l.edges.slice()};t.push(r)}return t}function tapEdge(e,t,o){var l=getEdge(e,t);if(-1!=l){var r=myEdges[l],s=-1;if(gIsDragging?lastSource!=r.s||2==lastState&&!wontMakeT(l)||(s=lastState):(lastSource=r.s,s=o?0!=r.s?0:1:0!=r.s?0:2,lastState=s),-1!=s&&s!=r.s){var n={tool:"setedge",es:s,addr:l,pe:CloneEdges(myEdges)};PushMove(n)}}lastX=e,lastY=t}function tapCell(e,t,o){var l=getCell(e,t),r=(currentPuzzleType,"#FFA"),s="Corral"==currentPuzzleType?"#AFA":"#AFF";if(-1!=l){var n,a=myCells[l];if(gIsDragging?n=lastFill:(n="yellow"==o&&a.fill!=r?r:"blue"==o&&a.fill!=s?s:"",lastFill=n),a.fill!=n){var i={tool:"setcell",addr:l,fill:n,prevFill:a.fill};PushMove(i)}}}function canvasClick(e){if(e.preventDefault(),!doSuccessAnimation){(new Date).getTime();var t=$(this).offset(),o=e;"touches"in e.originalEvent?o=e.originalEvent.touches[0]:"changedTouches"in e.originalEvent&&(o=e.originalEvent.changedTouches[0]),null==t&&(t=$(e.target).offset());var l=o.pageX-t.left,r=o.pageY-t.top,s=gCurrentTool;switch(e.shiftKey?s="clear":e.altKey?s="yellow":(e.metaKey||e.ctrlKey)&&(s="blue"),s){case"mark":tapEdge(l,r,!1);break;case"clear":tapEdge(l,r,!0);break;case"yellow":tapCell(l,r,"yellow");break;case"blue":tapCell(l,r,"blue")}}}function newEdge(e,t,o,l){return{x1:e,y1:t,x2:o,y2:l,s:0,f:0}}function newCell(e,t,o,l){return{clue:e,idx:l,x:t,y:o,fill:"",edges:[-1,-1,-1,-1]}}function addVert(e,t){var o={x:e,y:t};return myVerts.push(o),myVerts.length-1}var addEdge=function(e,t,o,l){var r=newEdge(e,t,o,l);return myEdges.push(r),myEdges.length-1},getCell=function(e,t){if(e-=gCellWidth/4,t-=gCellHeight/4,e/=gCellWidth,t/=gCellHeight,e<0||e>=puzzWidth||t<0||t>=puzzHeight)return-1;var o=Math.floor(t)*puzzWidth+Math.floor(e);return(o<0||o>=puzzMaxCells)&&(o=-1),o},getEdge=function(e,t){var o=e,l=t;o-=gCellWidth/4,l-=gCellHeight/4,(o/=gCellWidth)<=0&&(o=.01),(l/=gCellHeight)<=0&&(l=.01),o>=puzzWidth&&(o=puzzWidth-.01),l>=puzzHeight&&(l=puzzHeight-.01);var r=0,s=o-Math.round(o),n=l-Math.round(l),a=Math.abs(s),i=Math.abs(n);if(a<.1&&i<.1)return-1;if(0<=o&&o<puzzWidth&&0<=l&&l<puzzHeight){var u=coordsToAddress(Math.floor(o),Math.floor(l)),g=myCells[u];if(a<i){if(gIsDragging&&Math.abs(e-lastX)>Math.abs(t-lastY))return-1;r=g.edges[0<=s?3:1]}else{if(gIsDragging&&Math.abs(e-lastX)<Math.abs(t-lastY))return-1;r=g.edges[0<=n?0:2]}return r}return-1},localResize=function(){gCellWidth=Math.floor(gPuzzleWidth/(puzzWidth+.5)),gCellHeight=Math.floor(gPuzzleHeight/(puzzHeight+.5)),gFontHeight=Math.round(.4*gCellHeight)};function slitherlinkCanvasSetup(){gCanv=document.getElementById("puzzlecontainer"),myResize(),$(window).resize(myResize),setupCanvas();var e=isTouchscreen?"touchstart":"mousedown",t=isTouchscreen?"touchmove":"mousemove",o=isTouchscreen?"touchend":"mouseup";$("#puzzlecontainer").on(e,function(e){gIsDragging=!1,canvasClick(e),gIsDragging=!0,e.preventDefault()}),$("#puzzlecontainer").on(o,function(e){e.preventDefault(),gIsDragging=!1,$.cookie(currentPuzzleType.toLowerCase()+"_cells",JSON.stringify(myCells),{expires:14}),$.cookie(currentPuzzleType.toLowerCase()+"_edges",JSON.stringify(myEdges),{expires:14}),$.cookie(currentPuzzleType.toLowerCase()+"_solution_id",puzzleID,{useLocalStorage:!1,expires:14})}),$("#puzzlecontainer").on(t,function(e){gIsDragging&&(e.preventDefault(),canvasClick(e))}),$(window).on(o,function(e){gIsDragging=!1}),$("#tool_left").on(e,gotoPrevPuzzle),$("#tool_search").on(e,launchNavigation),$("#tool_right").on(e,gotoNextPuzzle),$("#tool_settings").on(e,launchSettings),$("#tool_undo").on(e,UndoMove),$("#tool_redo").on(e,RedoMove),$("#tool_clear").on(e,function(e){generateKey(" ",0,!1)}),$(".tool-btn").on(e,function(e){var t=$(this).data("tool");gCurrentTool=t,$(".tool-btn").removeClass("selected"),$(this).addClass("selected")}),ClearUndoHistory(),$.cookie(currentPuzzleType.toLowerCase()+"_edges")&&$.cookie(currentPuzzleType.toLowerCase()+"_cells")&&$.cookie(currentPuzzleType.toLowerCase()+"_solution_id",{useLocalStorage:!1})==puzzleID&&LoadUndoCookie(),initNewPuzzle(),SetUndoVisualState(),$(".dropdown-toggle").dropdown()}
